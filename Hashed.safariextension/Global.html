<!DOCTYPE HTML>
<html>
<head>
	<title>Global</title>
	<script src="PwdHash/md5.js" type="text/javascript"></script>
	<script src="PwdHash/hashed-password.js" type="text/javascript"></script>
	<script src="PwdHash/domain-extractor.js" type="text/javascript"></script>
	<script type="text/javascript">
		function generatePwdHash(event) {
			if (event.command === "generatepwdhash") {
				var URL = event.target.browserWindow.activeTab.url;
				if (!URL) return;
				
				var masterPassword = safari.extension.secureSettings.masterPassword;			
				if (!masterPassword) {
					event.target.browserWindow.activeTab.page.dispatchMessage("missingMasterPassword");
					return;
				}
				
				var domain = (new SPH_DomainExtractor()).extractDomain(URL);
				if (!domain) return;
	
				var result = new String(new SPH_HashedPassword(masterPassword, domain));
				if (!result) return;
				
				event.target.browserWindow.activeTab.page.dispatchMessage("pwdHash", result.valueOf());
				//event.target.browserWindow.activeTab.url = domain + '-' + result;
			}
		}
		function canGeneratePwdHash(event) {
			if (event.command === "generatepwdhash") {
				var URL = event.target.browserWindow.activeTab.url;
				var masterPassword = safari.extension.settings.masterPassword;
				event.target.disabled = false;
			}
		}
		safari.application.addEventListener("command", generatePwdHash, false);
		safari.application.addEventListener("validate", canGeneratePwdHash, false);
	</script>
</head>
<body>
</body>
</html>